```sql
DELIMITER $$

CREATE PROCEDURE populate_demo(
  IN target_users BIGINT,
  IN target_products BIGINT,
  IN target_orders BIGINT,
  IN batch_size INT
)
BEGIN
  DECLARE i BIGINT DEFAULT 0;
  DECLARE j BIGINT DEFAULT 0;
  DECLARE u_start BIGINT;
  DECLARE p_start BIGINT;
  DECLARE o_start BIGINT;
  -- Insert users
  SELECT COALESCE(MAX(user_id),0)+1 INTO u_start FROM users;
  SET i = u_start;
  WHILE i < u_start + target_users DO
    START TRANSACTION;
    SET j = 0;
    WHILE j < batch_size AND i < u_start + target_users DO
      INSERT INTO users (username,email,signup_date,country)
      VALUES (
        CONCAT('user',i),
        CONCAT('user',i,'@example.com'),
        DATE_SUB(CURDATE(), INTERVAL FLOOR(RAND()*1000) DAY),
        ELT(FLOOR(RAND()*5)+1,'ES','MX','US','BR','AR')
      );
      SET i = i + 1;
      SET j = j + 1;
    END WHILE;
    COMMIT;
  END WHILE;

  -- Insert products
  SELECT COALESCE(MAX(product_id),0)+1 INTO p_start FROM products;
  SET i = p_start;
  WHILE i < p_start + target_products DO
    START TRANSACTION;
    SET j = 0;
    WHILE j < batch_size AND i < p_start + target_products DO
      INSERT INTO products (sku,name,category_id,price,weight_grams)
      VALUES (
        CONCAT('SKU-',i),
        CONCAT('Producto ',i),
        FLOOR(RAND()*5)+1,
        ROUND(5 + RAND()*500,2),
        FLOOR(50 + RAND()*2000)
      );
      SET i = i + 1;
      SET j = j + 1;
    END WHILE;
    COMMIT;
  END WHILE;

  -- Insert orders + order_items + payments
  SELECT COALESCE(MAX(order_id),0)+1 INTO o_start FROM orders;
  SET i = o_start;
  WHILE i < o_start + target_orders DO
    START TRANSACTION;
    SET j = 0;
    WHILE j < batch_size AND i < o_start + target_orders DO
      -- pick random user
      SET @rand_user = (SELECT user_id FROM users ORDER BY RAND() LIMIT 1);
      INSERT INTO orders (user_id, order_date, status, billing_address_id, shipping_address_id, total)
      VALUES (@rand_user, DATE_SUB(NOW(), INTERVAL FLOOR(RAND()*365) DAY), ELT(FLOOR(RAND()*4)+1,'pending','processing','completed','cancelled'), NULL, NULL, 0.0);
      SET @last_order = LAST_INSERT_ID();
      -- insert random 1-5 items for the order (small loop)
      SET @k = 0;
      WHILE @k < (FLOOR(RAND()*5)+1) DO
        SET @prod = (SELECT product_id FROM products ORDER BY RAND() LIMIT 1);
        SET @qty = FLOOR(RAND()*5)+1;
        SET @price = (SELECT price FROM products WHERE product_id=@prod);
        INSERT INTO order_items (order_id, product_id, qty, price)
        VALUES (@last_order, @prod, @qty, @price);
        SET @k = @k + 1;
      END WHILE;
      -- update total
      UPDATE orders o
      SET o.total = (SELECT COALESCE(SUM(qty*price),0) FROM order_items WHERE order_id=o.order_id)
      WHERE o.order_id = @last_order;
      -- payment sometimes
      IF RAND() > 0.2 THEN
        INSERT INTO payments (order_id, paid_amount, paid_at, method)
        VALUES (@last_order, (SELECT total FROM orders WHERE order_id=@last_order), NOW(), ELT(FLOOR(RAND()*3)+1,'card','transfer','cash'));
      END IF;

      SET i = i + 1;
      SET j = j + 1;
    END WHILE;
    COMMIT;
  END WHILE;
END$$

DELIMITER ;

```

